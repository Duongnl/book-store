<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{base::layout(~{::section})}">

<head>
	<meta charset="ISO-8859-1">
	<title>Thêm Quản Trị Viên</title>
</head>

<body>


	<section>
		<div class="container mt-5 p-5">
			<div class="row">

				<div class="col-md-7 p-2 offset-md-2">
					<div class="card shadow p-3 mb-5 bg-body-tertiary rounded">
						<div class="card-header text-center">
							<p class="fs-4 text-center">Thêm Quản Trị Viên</p>
							<th:block th:if="${session.succMsg}">
								<p class="text-success fw-bold">[[${session.succMsg}]]</p>
								<th:block th:text="${@commnServiceImpl.removeSessionMessage()}"></th:block>
							</th:block>

							<th:block th:if="${session.errorMsg}">
								<p class="text-danger fw-bold">[[${session.errorMsg}]]</p>
								<th:block th:text="${@commnServiceImpl.removeSessionMessage()}"></th:block>
							</th:block>
						</div>
						<div class="card-body">
							<form id="addAdminForm" action="/admin/save-admin" enctype="multipart/form-data" method="post" novalidate>
								<div class="row">
									<div class="col">
										<label class="form-label">Họ và tên</label>
										<input required class="form-control" name="name" type="text" placeholder="Nhập họ và tên"
											minlength="3">
										<div class="invalid-feedback">Vui lòng nhập họ và tên (tối thiểu 3 ký tự).</div>
									</div>

									<div class="col">
										<label class="form-label">Số điện thoại</label>
										<input required class="form-control" name="mobileNumber" type="tel" placeholder="Nhập số điện thoại"
											pattern="^[0-9]{9,11}$">
										<div class="invalid-feedback">Số điện thoại gồm 9-11 chữ số.</div>
									</div>

								</div>

								<div class="mb-3">
									<label class="form-label">Email</label>
									<input required class="form-control" name="email" type="email" placeholder="nhap@email.com">
									<div class="invalid-feedback">Vui lòng nhập email hợp lệ.</div>
								</div>


								<div class="row">
									<div class="col">
										<label class="form-label">Địa chỉ</label>
										<input required class="form-control" name="address" type="text" placeholder="Số nhà/Đường">
										<div class="invalid-feedback">Vui lòng nhập địa chỉ.</div>
									</div>

									<div class="col">
										<label class="form-label">Thành phố</label>
										<input required class="form-control" name="city" type="text" placeholder="Thành phố">
										<div class="invalid-feedback">Vui lòng nhập thành phố.</div>
									</div>

								</div>

								<div class="row">
									<div class="col">
										<label class="form-label">Tỉnh/Thành</label>
										<input required class="form-control" name="state" type="text" placeholder="Tỉnh/Thành">
										<div class="invalid-feedback">Vui lòng nhập Tỉnh/Thành.</div>
									</div>

									<div class="col">
										<label class="form-label">Mã bưu điện</label>
										<input required class="form-control" name="pincode" type="text" placeholder="Mã bưu điện"
											pattern="^[0-9]{4,10}$">
										<div class="invalid-feedback">Mã bưu điện gồm 4-10 chữ số.</div>
									</div>

								</div>

								<div class="row">
									<div class="col">
										<label class="form-label">Mật khẩu</label>
										<input required class="form-control" name="password" type="password" placeholder="Nhập mật khẩu"
											minlength="6">
										<div class="invalid-feedback">Mật khẩu tối thiểu 6 ký tự.</div>
									</div>
									<div class="col">
										<label class="form-label">Xác nhận mật khẩu</label>
										<input required class="form-control" name="cpassword" type="password"
											placeholder="Nhập lại mật khẩu">
										<div class="invalid-feedback">Vui lòng nhập lại mật khẩu trùng khớp.</div>
									</div>
								</div>
								<div class="mb-3">
									<label class="form-label">Ảnh đại diện</label>
									<input class="form-control" name="img" type="file" accept="image/*">
									<small class="text-muted">Hỗ trợ JPG, PNG, WEBP (tối đa 5MB).</small>
								</div>
								<button type="submit" class="btn bg-primary text-white col-md-12">Đăng ký</button>
							</form>
						</div>


					</div>
				</div>
			</div>
		</div>

	</section>
	<script>
		// Bootstrap client-side validation
		(function () {
			const form = document.getElementById('addAdminForm');
			const emailInput = form.querySelector('input[name="email"]');
			form.addEventListener('submit', function (event) {
				// custom password match check
				const pwd = form.querySelector('input[name="password"]').value;
				const cpwd = form.querySelector('input[name="cpassword"]').value;
				if (pwd !== cpwd) {
					event.preventDefault();
					event.stopPropagation();
					form.querySelector('input[name="cpassword"]').setCustomValidity('Passwords do not match');
				} else {
					form.querySelector('input[name="cpassword"]').setCustomValidity('');
				}

				if (!form.checkValidity()) {
					event.preventDefault();
					event.stopPropagation();
				}
				form.classList.add('was-validated');
			}, false);

			// async email availability check
			emailInput.addEventListener('blur', async function () {
				const email = emailInput.value.trim();
				if (!email) return;
				try {
					const res = await fetch(`/admin/check-email?email=${encodeURIComponent(email)}`);
					if (!res.ok) return;
					const data = await res.json();
					if (data && data.exists) {
						emailInput.setCustomValidity('Email đã tồn tại. Vui lòng sử dụng email khác');
					} else {
						emailInput.setCustomValidity('');
					}
				} catch (e) {
					// network failure: do not block submission
					emailInput.setCustomValidity('');
				}
			});
		})();
	</script>
</body>

</html>